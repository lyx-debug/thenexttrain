<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>南京地铁-the-next-train</title>
    <style>
    body {
        font-family: "SimHei", sans-serif;
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        background-color: #f5f7fa;
        /* background-image: linear-gradient(to bottom, #f5f7fa 0%, #e4e8ed 100%); */
    }

    .navbar {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #6e8efb 0%, #a777e3 100%);
        padding: 15px 30px;
        border-bottom: 2px solid #5d6bc4;
        box-sizing: border-box;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        border-radius: 10px;
        transition: all 0.3s ease;
    }

    .navbar:hover {
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        transform: translateY(-2px);
    }

    .navbar a {
        text-decoration: none;
        color: white;
        font-weight: bold;
        font-size: 18px;
        transition: all 0.3s ease;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    .navbar a:hover {
        color: #ffeba7;
        transform: scale(1.05);
    }

    .navbar img {
        height: 40px;
        width: 120px;
        object-fit: contain;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    .navbar img:hover {
        transform: scale(1.05);
    }

    h1 {
        text-align: center;
        margin-bottom: 30px;
        color: #ff7e5f;
        font-family: SimHei;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        background: linear-gradient(to right, #ff7e5f, #feb47b);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-size: 2.2em;
        animation: fadeIn 0.8s ease-in-out;
    }

    .search-box {
        display: flex;
        gap: 10px;
        margin: 30px 0;
        animation: slideUp 0.5s ease-out;
    }

    input {
        flex: 1;
        padding: 12px 15px;
        border: 2px solid #d1d9e6;
        border-radius: 8px;
        font-size: 16px;
        background: #f0f4f8;
        transition: all 0.3s ease;
        box-shadow: inset 2px 2px 5px #d1d9e6, 
                    inset -2px -2px 5px #ffffff;
    }

    input:focus {
        border-color: #6e8efb;
        box-shadow: 0 0 10px rgba(110, 142, 251, 0.5),
                    inset 2px 2px 5px #d1d9e6, 
                    inset -2px -2px 5px #ffffff;
        outline: none;
        background: white;
    }

    button {
        padding: 12px 25px;
        background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        font-size: 16px;
        box-shadow: 0 4px 8px rgba(254, 180, 123, 0.3);
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(254, 180, 123, 0.4);
        background: linear-gradient(135deg, #feb47b 0%, #ff7e5f 100%);
    }

    button:active {
        transform: translateY(0);
    }

    .result {
        margin-top: 20px;
        animation: fadeIn 0.6s ease-out;
    }

    .station-name {
        font-size: 28px;
        margin-bottom: 20px;
        color: #2c3e50;
        font-weight: bold;
        text-align: center;
        position: relative;
        padding-bottom: 10px;
    }

    .station-name:after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 25%;
        width: 50%;
        height: 3px;
        background: linear-gradient(to right, #ff7e5f, #feb47b);
        border-radius: 3px;
    }

    .line-info {
        padding: 20px;
        margin: 15px 0;
        border-radius: 12px;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .line-info:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }

    .line-info h3 {
        margin: 0;
        font-size: 22px;
        position: relative;
        z-index: 2;
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .line-info:before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
            to bottom right,
            rgba(255,255,255,0.3) 0%,
            rgba(255,255,255,0) 60%
        );
        transform: rotate(30deg);
    }

    .autocomplete-items {
        border: 2px solid #d1d9e6;
        border-radius: 8px;
        z-index: 99;
        top: 100%;
        left: 0;
        right: 0;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        animation: fadeIn 0.3s ease-out;
        max-height: 300px;
        overflow-y: auto;
    }

    .autocomplete-item {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        cursor: pointer;
        background: white;
        border-bottom: 1px solid #eaeef2;
        transition: all 0.2s ease;
        transform: translateX(0);
    }

    .autocomplete-item strong {
        color: #808080;
        margin-right: 8px;
    }

    .autocomplete-item:hover {
        background: #f0f4f8;
        transform: translateX(5px);
        margin-right: 5px; /* 补偿translateX导致的宽度变化 */
    }

    table {
        width: 100%;
        margin: 20px auto;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        border-collapse: separate;
        border-spacing: 0;
        animation: fadeIn 0.7s ease-out;
    }

    thead {
        background: linear-gradient(135deg, #6e8efb 0%, #a777e3 100%);
        color: white;
    }

    th, td {
        padding: 14px;
        text-align: left;
        border-bottom: 1px solid #eaeef2;
    }

    th {
        font-weight: bold;
        text-transform: uppercase;
        font-size: 14px;
        letter-spacing: 1px;
    }

    tbody tr:nth-child(even) {
        background-color: #f8fafc;
    }

    tbody tr:hover {
        background-color: #f0f7ff;
        transform: scale(1.01);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    }

    .time-remaining {
        font-weight: bold;
        color: #4facfe;
        animation: pulse 1.5s infinite;
    }

    .arriving-soon {
        background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%) !important;
        color: white !important;
    }

    .arriving-soon td {
        color: white !important;
        border-bottom-color: rgba(255,255,255,0.2) !important;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from { 
            opacity: 0;
            transform: translateY(20px);
        }
        to { 
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes pulse {
        0% { color: #4facfe; }
        50% { color: #00f2fe; }
        100% { color: #4facfe; }
    }

    /* 响应式布局 */
    @media (max-width: 600px) {
        body {
            padding: 10px;
        }
        
        .navbar {
            padding: 10px 15px;
            flex-direction: column;
            gap: 10px;
        }
        
        .search-box {
            flex-direction: column;
        }
        
        button {
            width: 100%;
        }
        
        table, thead, tbody, th, td, tr {
            display: block;
        }

        thead tr {
            display: none;
        }

        tr {
            margin-bottom: 15px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        td {
            text-align: right;
            padding-left: 50%;
            position: relative;
        }

        td:before {
            content: attr(data-label);
            position: absolute;
            left: 10px;
            width: calc(50% - 20px);
            padding-right: 10px;
            white-space: nowrap;
            font-weight: bold;
            text-align: left;
            color: #6e8efb;
        }
    }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <div class="navbar">
        <!-- 左侧导航按钮 -->
        <a href="about.html" target="_self">关于</a>

        <!-- 右侧图片占位符 -->
        <img src="placeholder.png" alt="">
    </div>

    <h1 style="text-align: center; color: orange; margin-bottom: 30px; font-family: SimHei">南京地铁 The-Next-Train</h1>
    <div class="search-box">
        <input type="text" id="stationInput" placeholder="输入地铁站名称 如 新街口/xjk" oninput="showSuggestions(this.value)" onclick="showSuggestions(this.value)">
        <button onclick="searchStation()">搜索</button>
    </div>
    <div id="autocomplete-list" class="autocomplete-items"></div>
    <div id="result" class="result"></div>
    <div id="lineInfo"></div>

    <script src="./stationdata.js"></script>
    <script src="./pinyinpro.min.js"></script>
    <script>
        // 获取当前日期的星期几
        function getWeekDay() {
            const now = new Date();
            return now.getDay();
        }

        // 根据星期几选择相应的数据（4号线）
        function getArrivalTimesForToday(arrivalTimes) {
            const weekDay = getWeekDay();
            console.log(`Today is day: ${weekDay}`);

            const arrivalTimesForToday = {
                0: arrivalTimes.sunday,
                1: arrivalTimes.monday,
                2: arrivalTimes.tuesday,
                3: arrivalTimes.wednesday,
                4: arrivalTimes.thursday,
                5: arrivalTimes.friday,
                6: arrivalTimes.saturday,
            }[weekDay] || [];

            console.log("Arrival times for today:", arrivalTimesForToday);
            return Array.isArray(arrivalTimesForToday)? arrivalTimesForToday : [];
        }

        function padTime(number) {
            return String(number).padStart(2, '0');
        }

        function getCurrentTimeString() {
            const now = new Date();
            return `${padTime(now.getHours())}:${padTime(now.getMinutes())}:${padTime(now.getSeconds())}`;
        }

        function parseTimeString(timeString) {
            const [hours, minutes, seconds] = timeString.split(':').map(Number);
            return { hours, minutes, seconds };
        }

        function calculateTimeRemaining(arrivalTime, currentTime) {
            const { hours: arrivalHours, minutes: arrivalMinutes, seconds: arrivalSeconds } = arrivalTime;
            const { hours: currentHours, minutes: currentMinutes, seconds: currentSeconds } = currentTime;

            const arrivalTotalSeconds = arrivalHours * 3600 + arrivalMinutes * 60 + arrivalSeconds;
            const currentTotalSeconds = currentHours * 3600 + currentMinutes * 60 + currentSeconds;

            let timeRemainingSeconds = arrivalTotalSeconds - currentTotalSeconds;
            if (timeRemainingSeconds < 0) {
                timeRemainingSeconds += 24 * 3600;
            }

            const hours = Math.floor(timeRemainingSeconds / 3600);
            timeRemainingSeconds %= 3600;
            const minutes = Math.floor(timeRemainingSeconds / 60);
            const seconds = Math.floor(timeRemainingSeconds % 60);

            return {
                hours,
                minutes,
                seconds,
                totalSeconds: arrivalTotalSeconds - currentTotalSeconds,
                timeString: `${padTime(hours)}小时 ${padTime(minutes)}分钟 ${padTime(seconds)}秒`
            };
        }

        function updateTable(tableId, arrivalTimesForToday) {
            console.log(tableId);
            console.log(arrivalTimesForToday);
            const tableBody = document.getElementById(tableId);
            tableBody.innerHTML = '';

            const currentTimeString = getCurrentTimeString();
            console.log(`Current time: ${currentTimeString}`);
            const currentTime = parseTimeString(currentTimeString);

            if (arrivalTimesForToday.length === 0) {
                console.log("No arrival times available for today.");
                return;
            }

            // 过滤掉已经过站的列车和到站时间超过30分钟的列车
            const filteredArrivalTimes = arrivalTimesForToday.filter(train => {
                const arrivalTime = parseTimeString(train.time);
                const timeRemaining = calculateTimeRemaining(arrivalTime, currentTime);
                const arrivalTotalSeconds = arrivalTime.hours * 3600 + arrivalTime.minutes * 60 + arrivalTime.seconds;
                const currentTotalSeconds = currentTime.hours * 3600 + currentTime.minutes * 60 + currentTime.seconds;

                return arrivalTotalSeconds > currentTotalSeconds && timeRemaining.totalSeconds <= 1800;
            });

            console.log(`Filtered arrival times:`, filteredArrivalTimes);

            // 计算剩余时间并排序
            const sortedArrivalTimes = filteredArrivalTimes.map(train => ({
                ...train,
                timeRemaining: calculateTimeRemaining(parseTimeString(train.time), currentTime)
            })).sort((a, b) => a.timeRemaining.hours * 3600 + a.timeRemaining.minutes * 60 + a.timeRemaining.seconds -
                (b.timeRemaining.hours * 3600 + b.timeRemaining.minutes * 60 + b.timeRemaining.seconds));

            console.log(`Sorted arrival times:`, sortedArrivalTimes);

            sortedArrivalTimes.forEach(train => {
                const row = document.createElement('tr');

                const destinationCell = document.createElement('td');
                destinationCell.textContent = train.destination;
                row.appendChild(destinationCell);

                const arrivalTimeCell = document.createElement('td');
                arrivalTimeCell.textContent = train.time;
                row.appendChild(arrivalTimeCell);

                const timeRemainingCell = document.createElement('td');
                timeRemainingCell.className = 'time-remaining';
                timeRemainingCell.textContent = train.timeRemaining.timeString;
                row.appendChild(timeRemainingCell);

                const jiaoluCell = document.createElement('td');
                jiaoluCell.textContent = train.jiaolu;
                row.appendChild(jiaoluCell);

                const statusCell = document.createElement('td');
                statusCell.textContent = '正常';
                row.appendChild(statusCell);

                row.classList.remove('arriving-soon');

                if (train.timeRemaining.totalSeconds <= 60 && train.timeRemaining.totalSeconds > 0) {
                    row.classList.add('arriving-soon');
                    statusCell.textContent = '即将进站';
                }

                let statusUpdated = false;

                function updateStatus() {
                    if (train.timeRemaining.totalSeconds > 0) {
                        if (train.timeRemaining.totalSeconds <= 60) {
                            statusCell.textContent = '即将进站';
                            row.classList.add('arriving-soon');
                        } else {
                            statusCell.textContent = '正常';
                            row.classList.remove('arriving-soon');
                        }
                    } else {
                        if (train.timeRemaining.totalSeconds === 0) {
                            statusUpdated = true;
                            statusCell.textContent = '正在离开';
                            setTimeout(() => {
                                row.style.display = 'none';
                            }, 5000);
                        }
                    }
                }

                // 每秒更新状态列
                const intervalId = setInterval(() => {
                    if (!statusUpdated) {
                        train.timeRemaining.totalSeconds--;
                        timeRemainingCell.textContent = `${padTime(Math.floor(train.timeRemaining.totalSeconds / 3600))}小时 ${padTime(Math.floor((train.timeRemaining.totalSeconds % 3600) / 60))}分钟 ${padTime(train.timeRemaining.totalSeconds % 60)}秒`;
                        updateStatus();
                    } else {
                        clearInterval(intervalId);
                    }
                }, 1000);

                updateStatus();
                tableBody.appendChild(row);
            });
        }
    </script>
    <script>
        function loadScript(url, callback, args) {
            // Adding the script tag to the head as suggested before
            var head = document.head;
            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = url;

            // Then bind the event to the callback function.
            // There are several events for cross browser compatibility.
            script.onreadystatechange = () => callback(args);
            script.onload = () => callback(args);
            script.async = true;

            // Fire the loading
            head.appendChild(script);
        }

        // 页面加载完成时自动聚焦到输入框
        window.onload = function() {
            document.getElementById("stationInput").focus(); // 页面加载完成后，自动聚焦到搜索框
            showSuggestions("");
        };

        function matchesPinyin(input, pinyin) {
            if (!pinyin) return false;
            if (pinyin.toLowerCase().includes(input.toLowerCase())) {
                return true;
            }
            const initials = pinyin.split('').filter(c => /[a-z]/.test(c)).join('');
            return initials.toLowerCase().includes(input.toLowerCase());
        }

        function showSuggestions(input) {
            console.log("Show suggestions " + input);
            const autocompleteList = document.getElementById("autocomplete-list");
            autocompleteList.innerHTML = "";
            
            // Group stations by name to handle transfer stations
            const stationMap = new Map();
            
            metroLines.forEach(line => {
                line.stations.forEach(station => {
                    const pinyin = pinyinPro.pinyin(station.name, { toneType: 'none' }) || "";
                    const pinyinInitials = pinyin.split(" ").map(s => s[0]).join("");
                    const match1 = station.name.toLowerCase().includes(input.toLowerCase());
                    const match2 = pinyinInitials.toLowerCase().includes(input.toLowerCase());
                    if (match1 || match2) {
                        if (!stationMap.has(station.name)) {
                            stationMap.set(station.name, {
                                station: station,
                                lines: []
                            });
                        }
                        stationMap.get(station.name).lines.push(line);
                    }
                });
            });

            // Create suggestions from the map
            stationMap.forEach((value, stationName) => {
                const item = document.createElement("div");
                item.className = "autocomplete-item";
                
                // Create line circles
                const lineCircles = value.lines.map(line => {
                    return `<span style="
                        display: inline-block;
                        width: 20px;
                        height: 20px;
                        background: ${line.color};
                        border-radius: 50%;
                        text-align: center;
                        line-height: 20px;
                        color: white;
                        font-size: 12px;
                        margin-left: 5px;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    ">${line.name}</span>`;
                }).join("");
                
                item.innerHTML = `
                    <strong>${stationName}</strong>
                    ${lineCircles}
                `;
                
                item.addEventListener("click", () => {
                    document.getElementById("stationInput").value = stationName;
                    searchStation();
                    autocompleteList.innerHTML = "";
                });
                
                autocompleteList.appendChild(item);
            });
        }

        function searchStation() {
            const autocompleteList = document.getElementById("autocomplete-list");
            autocompleteList.innerHTML = "";
            const input = document.getElementById("stationInput").value.trim();
            const resultDiv = document.getElementById("result");
            resultDiv.innerHTML = "";

            // 确保点击搜索时聚焦到输入框
            document.getElementById("stationInput").focus();

            if (!input) {
                resultDiv.innerHTML = "<div>请输入站点名称</div>";
                return;
            }

            const foundLines = metroLines.filter(line => 
                line.stations.some(station => 
                    station.name.toLowerCase() === input.toLowerCase()
                )
            );

            if (foundLines.length === 0) {
                resultDiv.innerHTML = "<div>未找到相关站哦，请重试～</div>";
                return;
            }

            const output = document.createElement("div");
            output.innerHTML = `<div class="station-name">${input}</div>`;

            const lineNames = foundLines.map(line => line.name + "号线").join(" "); // 线路文字间隔

            // 判断站点是否为换乘站
            const isTransferStation = foundLines.some(line =>
                line.stations.some(station => 
                    station.name.toLowerCase() === input.toLowerCase() && station.isTransferStation
                )
            );

            const lineInfo = document.createElement("div");
            lineInfo.className = "line-info";
            lineInfo.style.background = isTransferStation 
                ? `linear-gradient(to right, ${foundLines.map(line => line.color).join(", ")})`
                : foundLines[0].color;

            lineInfo.innerHTML = `
                <h3>${lineNames}</h3>
            `;
            const stationHtmlMapping = {
                "龙江": "./station/4/龙江.html",
                "草场门": "./station/interchangestation/草场门.html",
                "云南路": "./station/4/云南路.html",
                "鼓楼": "./station/interchangestation/鼓楼.html",
                "鸡鸣寺": "./station/interchangestation/鸡鸣寺.html",
                "九华山": "./station/4/九华山.html",
                // 继续添加其他站点和对应的 HTML 页面
            };
            function updateStatus() {
                table = document.getElementById("lineInfo");
                table.innerHTML = "";
                clearInterval();
                for (_ of foundLines.map(line => [line.name, line.color])) {
                    i = _[0]; col = _[1];
                    table.innerHTML += `\
                    <h1 style="-webkit-background-clip: text!important; background: ${col};">${i}号线 ${input} </h1>\
                    <table>\
                        <thead>\
                            <tr>\
                                <th>终点站</th>\
                                <th>到站时间</th>\
                                <th>状态</th>\
                                <th>交路模式</th>\
                                <th>列车状态</th>\
                            </tr>\
                        </thead>\
                        <tbody id='train-table-body-${i}'>\
                        </tbody>\
                    </table>`;
                    const moduleName = "./beautified_js/" + input + "_" + i + ".js";
                    function callback(args) {
                        updateTable("train-table-body-" + args, getArrivalTimesForToday(arrivalTimes));
                    }
                    loadScript(moduleName, callback, i);
                }
                // const htmlPage = stationHtmlMapping[input] || "./default.html";
                // window.location.href = htmlPage;
            }
            updateStatus();
            lineInfo.addEventListener("click", () => {
                const htmlPage = stationHtmlMapping[input] || "./default.html";
                window.location.href = htmlPage;
            });
            output.appendChild(lineInfo);

            resultDiv.appendChild(output);
        }
    </script>
</body>
</html>
