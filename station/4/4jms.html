<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ—è½¦åˆ°ç«™æ—¶é—´è¡¨</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        th {
            background-color: #f2f2f2;
            text-align: left;
        }
        .time-remaining {
            font-weight: bold;
            color: #2ADC25; /* å€’è®¡æ—¶é¢œè‰² */
        }
        .arriving-soon {
            background-color: #4A772A; /* åˆ—è½¦åœ¨1åˆ†é’Ÿå†…åˆ°è¾¾æ—¶çš„èƒŒæ™¯è‰² */
        }
    </style>
</head>
<body>

<h1>4å·çº¿ é¸¡é¸£å¯º</h1>
<h5>  å¼€å‘è€…ï¼šNFLS-lyx,NFLS-xcx</h5>
<h5>  æµ‹è¯•äººå‘˜ï¼šNFLS-xxy,ğ–´ğ—‡ğ—‚ğ–²ğ–¾ğ–¯ğ–³-Furry</h5>

<table>
    <thead>
        <tr>
            <th>ç»ˆç‚¹ç«™</th>
            <th>åˆ°ç«™æ—¶é—´</th>
            <th>çŠ¶æ€</th>
            <th>äº¤è·¯æ¨¡å¼</th>
            <th>åˆ—è½¦çŠ¶æ€</th>
        </tr>
    </thead>
    <tbody id="train-table-body">
        <!-- æ•°æ®å°†ç”±JavaScriptåŠ¨æ€å¡«å…… -->
    </tbody>
</table>

<body>

<script type="module">
    import arrivalTimes from "./js/4jmstrainData.js";

    // è·å–å½“å‰æ—¥æœŸçš„æ˜ŸæœŸå‡ 
    function getWeekDay() {
        const now = new Date();
        return now.getDay(); // è¿”å›å€¼ï¼š0ï¼ˆå‘¨æ—¥ï¼‰åˆ°6ï¼ˆå‘¨å…­ï¼‰
    }

    // æ ¹æ®æ˜ŸæœŸå‡ é€‰æ‹©ç›¸åº”çš„æ•°æ®
    function getArrivalTimesForToday() {
        const weekDay = getWeekDay();
        console.log(`Today is day: ${weekDay}`); // è°ƒè¯•ä¿¡æ¯

        const arrivalTimesForToday = {
            0: arrivalTimes.sunday,
            1: arrivalTimes.monday,
            2: arrivalTimes.tuesday,
            3: arrivalTimes.wednesday,
            4: arrivalTimes.thursday,
            5: arrivalTimes.friday,
            6: arrivalTimes.saturday,
        }[weekDay] || [];

        console.log("Arrival times for today:", arrivalTimesForToday); // è°ƒè¯•ä¿¡æ¯
        return Array.isArray(arrivalTimesForToday) ? arrivalTimesForToday : [];
    }

    function padTime(number) {
        return String(number).padStart(2, '0');
    }

    function getCurrentTimeString() {
        const now = new Date();
        return `${padTime(now.getHours())}:${padTime(now.getMinutes())}:${padTime(now.getSeconds())}`;
    }

    function parseTimeString(timeString) {
        const [hours, minutes, seconds] = timeString.split(':').map(Number);
        return { hours, minutes, seconds };
    }

    function calculateTimeRemaining(arrivalTime, currentTime) {
        const { hours: arrivalHours, minutes: arrivalMinutes, seconds: arrivalSeconds } = arrivalTime;
        const { hours: currentHours, minutes: currentMinutes, seconds: currentSeconds } = currentTime;

        const arrivalTotalSeconds = arrivalHours * 3600 + arrivalMinutes * 60 + arrivalSeconds;
        const currentTotalSeconds = currentHours * 3600 + currentMinutes * 60 + currentSeconds;

        let timeRemainingSeconds = arrivalTotalSeconds - currentTotalSeconds;
        if (timeRemainingSeconds < 0) {
            timeRemainingSeconds += 24 * 3600; // å¤„ç†è·¨å¤©æƒ…å†µ
        }

        const hours = Math.floor(timeRemainingSeconds / 3600);
        timeRemainingSeconds %= 3600;
        const minutes = Math.floor(timeRemainingSeconds / 60);
        const seconds = Math.floor(timeRemainingSeconds % 60);

        return { 
            hours, 
            minutes, 
            seconds, 
            totalSeconds: arrivalTotalSeconds - currentTotalSeconds, // è¿™é‡Œæ·»åŠ  totalSeconds å±æ€§
            timeString: `${padTime(hours)}å°æ—¶ ${padTime(minutes)}åˆ†é’Ÿ ${padTime(seconds)}ç§’` 
        };
    }

    function updateTable() {
        const tableBody = document.getElementById('train-table-body');
        tableBody.innerHTML = ''; // æ¸…ç©ºè¡¨æ ¼å†…å®¹

        const currentTimeString = getCurrentTimeString();
        console.log(`Current time: ${currentTimeString}`); // è°ƒè¯•ä¿¡æ¯
        const currentTime = parseTimeString(currentTimeString);

        const arrivalTimesForToday = getArrivalTimesForToday();
        console.log(`Arrival times for today:`, arrivalTimesForToday); // è°ƒè¯•ä¿¡æ¯

        if (arrivalTimesForToday.length === 0) {
            console.log("No arrival times available for today.");
            return;
        }

        // è¿‡æ»¤æ‰å·²ç»è¿‡ç«™çš„åˆ—è½¦å’Œåˆ°ç«™æ—¶é—´è¶…è¿‡30åˆ†é’Ÿçš„åˆ—è½¦
        const filteredArrivalTimes = arrivalTimesForToday.filter(train => {
            const arrivalTime = parseTimeString(train.time);
            const timeRemaining = calculateTimeRemaining(arrivalTime, currentTime);
            const arrivalTotalSeconds = arrivalTime.hours * 3600 + arrivalTime.minutes * 60 + arrivalTime.seconds;
            const currentTotalSeconds = currentTime.hours * 3600 + currentTime.minutes * 60 + currentTime.seconds;

            return arrivalTotalSeconds > currentTotalSeconds && timeRemaining.totalSeconds <= 1800; // 30åˆ†é’Ÿ = 1800ç§’
        });

        console.log(`Filtered arrival times:`, filteredArrivalTimes); // è°ƒè¯•ä¿¡æ¯

        // è®¡ç®—å‰©ä½™æ—¶é—´å¹¶æ’åº
        const sortedArrivalTimes = filteredArrivalTimes.map(train => ({
            ...train,
            timeRemaining: calculateTimeRemaining(parseTimeString(train.time), currentTime)
        })).sort((a, b) => a.timeRemaining.hours * 3600 + a.timeRemaining.minutes * 60 + a.timeRemaining.seconds - 
                          (b.timeRemaining.hours * 3600 + b.timeRemaining.minutes * 60 + b.timeRemaining.seconds));

        console.log(`Sorted arrival times:`, sortedArrivalTimes); // è°ƒè¯•ä¿¡æ¯

        sortedArrivalTimes.forEach(train => {
            const row = document.createElement('tr');

            const destinationCell = document.createElement('td');
            destinationCell.textContent = train.destination;
            row.appendChild(destinationCell);

            const arrivalTimeCell = document.createElement('td');
            arrivalTimeCell.textContent = train.time;
            row.appendChild(arrivalTimeCell);

            const timeRemainingCell = document.createElement('td');
            timeRemainingCell.className = 'time-remaining';
            timeRemainingCell.textContent = train.timeRemaining.timeString;
            row.appendChild(timeRemainingCell);

            const jiaoluCell = document.createElement('td');
            jiaoluCell.textContent = train.jiaolu;
            row.appendChild(jiaoluCell);

            const statusCell = document.createElement('td');
            statusCell.textContent = 'æ­£å¸¸';
            row.appendChild(statusCell);

            row.classList.remove('arriving-soon');
            
            if (train.timeRemaining.totalSeconds <= 60 && train.timeRemaining.totalSeconds > 0) { 
                row.classList.add('arriving-soon'); 
                statusCell.textContent = 'å³å°†è¿›ç«™'; 
            }

            let statusUpdated = false;

            function updateStatus() {
                if (train.timeRemaining.totalSeconds > 0) {
                    if (train.timeRemaining.totalSeconds <= 60) {
                        statusCell.textContent = 'å³å°†è¿›ç«™';
                        row.classList.add('arriving-soon');
                    } else {
                        statusCell.textContent = 'æ­£å¸¸';
                        row.classList.remove('arriving-soon');
                    }
                } else {
                    if (train.timeRemaining.totalSeconds === 0) {
                        statusUpdated = true;
                        statusCell.textContent = 'æ­£åœ¨ç¦»å¼€';
                        setTimeout(() => {
                            row.style.display = 'none';
                        }, 5000); // å†ç­‰å¾…5ç§’é’Ÿåéšè—è¡Œ
                    }
                }
            }

            // æ¯ç§’æ›´æ–°çŠ¶æ€åˆ—
            const intervalId = setInterval(() => {
                if (!statusUpdated) {
                    train.timeRemaining.totalSeconds--;
                    updateStatus();
                } else {
                    clearInterval(intervalId);
                }
            }, 1000);

            // å¦‚æœåˆ—è½¦åœ¨1åˆ†é’Ÿå†…åˆ°è¾¾ï¼Œå°†è¯¥è¡Œçš„èƒŒæ™¯è‰²æ›´æ”¹ä¸ºæ·±ç»¿è‰²
            if (train.timeRemaining.totalSeconds <= 60 && train.timeRemaining.totalSeconds > 0) {
                row.classList.add('arriving-soon');
            }

            updateStatus(); // åˆå§‹æ›´æ–°
            tableBody.appendChild(row);
        });
    }

    // åˆå§‹æ›´æ–°è¡¨æ ¼
    updateTable();

    // æ¯ç§’æ›´æ–°ä¸€æ¬¡è¡¨æ ¼
    setInterval(updateTable, 1000);
</script>
</body>
</html>
